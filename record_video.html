<!DOCTYPE HTML>

<html>
<head>
    <link href="https://vjs.zencdn.net/5.11/video-js.min.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/5.11/video.min.js"></script>
    <script src="RecordRTC/RecordRTC.js"></script>
    <script src="videojs-record/src/js/videojs.record.js"></script>
    <script src="fine-uploader/fine-uploader.js"></script>
    <script> window.t = function t(){alert('fff')};</script>
    <link href="videojs-record/src/css/videojs.record.css" rel="stylesheet">
</head>
<body>
    <video id="myVideo" class="video-js vjs-default-skin"></video>

    <script>

var record_is_stopped = false;


var uploader = new qq.FineUploaderBasic({
            debug: true,
            request: {
                endpoint: window.url_record
            },
            validation: {
                allowedExtensions: ['video/webm']
            },
            callbacks: {
                onAllComplete: function(succeeded, failed) {
                    window.close();
                  }
            }
        });


var player = videojs("myVideo",
{
    controls: true,
    width: 320,
    height: 240,
    autoplay: true,
    controlBar: {
        volumeMenuButton: false
    },
    plugins: {
        record: {
            audio: false,
            video: true,
            maxLength: 2000,
            debug: true,
            videoMimeType: 'video/webm;codecs=H264'
        }
    }
});


//player.recorder.start();
setInterval (alert_if_lost_focus, 10000);



// error handling
player.on('deviceError', function()
{
    console.warn('device error:', player.deviceErrorCode);
});
player.on('error', function(error)
{
    console.log('error:', error);
});
// user clicked the record button and started recording
player.on('startRecord', function()
{
    console.log('started recording!');

});
// user completed recording and stream is available
player.on('finishRecord', function()
{
    // the blob object contains the recorded data that
    // can be downloaded by the user, stored on server etc.
    //console.log('finished recording: ', player.recordedData);

    //var url = window.url_record + '?data=' + player.recordedData;

    //var newWin = window.open(url,'windowName','height=800,width=800', 'scrollbars=yes', 'ff=f');            

    //console.log(player.recordedData);
    record_is_stopped = true;

    var file = player.recordedData;
    var filesList = [file];
    uploader.addFiles(filesList);
    uploader.uploadStoredFiles ();


    //var uploads = filesList.getUploads({status: qq.status.DELETED});

    //while (uploader.getInProgress()>0){
    //    
    //};

    //player.recorder.saveAs({'video': 'my-video-file-name'});
});



function alert_if_lost_focus ()
{
    if (!player.recorder.isRecording() && !record_is_stopped){    
        alert("Запись не включена!!! Включите запись");
    }
}


//window.onbeforeunload = function()
//{

    //player.recorder.stop();
    
    //var file = player.recordedData;
    //var filesList = [file];
    //uploader.addFiles(filesList);

    
    //return 'fff';
//}



</script>
</body>
</html>